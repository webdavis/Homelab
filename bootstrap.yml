---
# Run this playbook from the managing node (usually localhost) to bootstrap a new Raspberry Pi
# with essential system settings.
#
# Usage: this playbook can be run, as follows:
#
#    $ ./pw poetry run --venv in-project ansible-playbook bootstrap.yml

- name: Configure basic server security
  hosts: unprovisioned_yoshimo
  become: true
  gather_facts: true
  ignore_unreachable: true
  tasks:
    - name: Check if host is reachable
      ansible.builtin.ping:
      register: ping_result
      ignore_errors: true

    - name: End play if host is unreachable
      ansible.builtin.meta: end_play
      when: ping_result is defined and ping_result.unreachable is defined and ping_result.unreachable

    - name: Import ansible-bootstrap role
      ansible.builtin.import_role:
        name: ansible_bootstrap

    - name: Import security role
      ansible.builtin.import_role:
        name: security

- name: Cleanup
  hosts: yoshimo
  become: true
  gather_facts: true
  tasks:
    - name: Import remove-account role
      ansible.builtin.import_role:
        name: remove_account
